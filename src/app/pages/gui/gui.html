<main class="main">
  <div class="content">
    <h1>Maps</h1>

    <app-error-display />

    @if (activeEvents().length > 0) {
      <app-event [activeEvents]="activeEvents()" />
    }
    @if (currentTileDetails()) {
      <app-tile
        [currentTileDetails]="currentTileDetails()!"
        [selectedCharacter]="selectedCharacter()"
        (closeTrigger)="closeTileDetails()" />
    }

    <app-map
      [characters]="characters()"
      [selectedCharacter]="selectedCharacter()"
      [selectedTile]="selectedTile()"
      (tileClick)="onTileClick($event)" />

    @if (selectedCharacter() && showInventory()) {
      <app-inventory [selectedCharacter]="selectedCharacter()!" (onClose)="toggleInventory()" />
    }
    @if (selectedCharacter() && showSkills()) {
      <app-skill [selectedCharacter]="selectedCharacter()!" (closeTrigger)="toggleSkills()" />
    }
    @if (selectedCharacter() && showEquipment()) {
      <app-equipment [selectedCharacter]="selectedCharacter()!" (closeTrigger)="toggleEquipment()" />
    }

    <div class="characters-layer">
      @for (character of characters(); track character.name) {
        <div
          class="character"
          role="button"
          tabindex="0"
          [class.on-cooldown]="isCharacterOnCooldown(character)"
          [class.selected]="isSelected(character)"
          (click)="selectCharacter(character)">
          <div class="character-name">{{ character.name }}</div>
          <div class="character-stats-inline">
            <div class="stat-inline">HP: {{ character.hp }}/{{ character.max_hp }}</div>
            <div class="stat-inline">XP: {{ character.xp }}/{{ character.max_xp }}</div>
          </div>
          @if (isCharacterOnCooldown(character)) {
            <div class="cooldown-indicator">{{ getCharacterCooldown(character.name)?.remainingSeconds }}s</div>
          }
        </div>
      }
      @if (selectedCharacter()) {
        <button
          class="rest-button"
          type="button"
          [disabled]="isCharacterHpFull(selectedCharacter()!)"
          (click)="actionService.restCharacter()">
          @if (isCharacterOnCooldown(selectedCharacter()!)) {
            Queue Rest
          } @else {
            Rest
          }
        </button>

        <button class="panel-toggle-button" type="button" [class.active]="showInventory()" (click)="toggleInventory()">
          üì¶ Inventory
        </button>

        <button class="panel-toggle-button" type="button" [class.active]="showSkills()" (click)="toggleSkills()">
          üìä Skills
        </button>

        <button class="panel-toggle-button" type="button" [class.active]="showEquipment()" (click)="toggleEquipment()">
          ‚öîÔ∏è Equipment
        </button>
      }
    </div>
  </div>
</main>
